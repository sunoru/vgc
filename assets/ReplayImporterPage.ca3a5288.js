import{c as U,r as $,a as j,e as W,o as Q,h as V,g as E,x as L,F as D,y as H,z as J,A as z,B as R,a8 as N,G,a9 as X,aa as K,ab as B,ac as Y}from"./index.51b85b29.js";import{b as Z}from"./format.b15566b8.js";import{Q as tt,a as et}from"./QForm.3990bd96.js";import{s as M,a as st}from"./dialog.65cf8674.js";import{_ as at}from"./PageBase.61562b05.js";import{_ as ot}from"./plugin-vue_export-helper.21dcd24c.js";import"./use-dark.7cdd0250.js";import"./QPage.20833116.js";const q=XMLHttpRequest,O=q.prototype.open,nt=["top","right","bottom","left"];let T=[],P=0;function rt({p:t,pos:e,active:a,horiz:n,reverse:o,dir:r}){let s=1,i=1;return n===!0?(o===!0&&(s=-1),e==="bottom"&&(i=-1),{transform:`translate3d(${s*(t-100)}%,${a?0:i*-200}%,0)`}):(o===!0&&(i=-1),e==="right"&&(s=-1),{transform:`translate3d(${a?0:r*s*-200}%,${i*(t-100)}%,0)`})}function it(t,e){return typeof e!="number"&&(t<25?e=Math.random()*3+3:t<65?e=Math.random()*3:t<85?e=Math.random()*2:t<99?e=.6:e=0),Z(t+e,0,100)}function lt(t){P++,T.push(t),!(P>1)&&(q.prototype.open=function(e,a){const n=[],o=()=>{T.forEach(s=>{(s.hijackFilter.value===null||s.hijackFilter.value(a)===!0)&&(s.start(),n.push(s.stop))})},r=()=>{n.forEach(s=>{s()})};this.addEventListener("loadstart",o,{once:!0}),this.addEventListener("loadend",r,{once:!0}),O.apply(this,arguments)})}function ct(t){T=T.filter(e=>e.start!==t),P=Math.max(0,P-1),P===0&&(q.prototype.open=O)}var ut=U({name:"QAjaxBar",props:{position:{type:String,default:"top",validator:t=>nt.includes(t)},size:{type:String,default:"2px"},color:String,skipHijack:Boolean,reverse:Boolean,hijackFilter:Function},emits:["start","stop"],setup(t,{emit:e}){const{proxy:a}=E(),n=$(0),o=$(!1),r=$(!0);let s=0,i,p;const g=j(()=>`q-loading-bar q-loading-bar--${t.position}`+(t.color!==void 0?` bg-${t.color}`:"")+(r.value===!0?"":" no-transition")),m=j(()=>t.position==="top"||t.position==="bottom"),I=j(()=>m.value===!0?"height":"width"),k=j(()=>{const c=o.value,d=rt({p:n.value,pos:t.position,active:c,horiz:m.value,reverse:a.$q.lang.rtl===!0&&["top","bottom"].includes(t.position)?t.reverse===!1:t.reverse,dir:a.$q.lang.rtl===!0?-1:1});return d[I.value]=t.size,d.opacity=c?1:0,d}),u=j(()=>o.value===!0?{role:"progressbar","aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":n.value}:{"aria-hidden":"true"});function b(c=300){const d=p;return p=Math.max(0,c)||0,s++,s>1?(d===0&&c>0?w():d>0&&c<=0&&clearTimeout(i),s):(clearTimeout(i),e("start"),n.value=0,i=setTimeout(()=>{r.value=!0,c>0&&w()},o.value===!0?500:1),o.value!==!0&&(o.value=!0,r.value=!1),s)}function S(c){return s>0&&(n.value=it(n.value,c)),s}function _(){if(s=Math.max(0,s-1),s>0)return s;clearTimeout(i),e("stop");const c=()=>{r.value=!0,n.value=100,i=setTimeout(()=>{o.value=!1},1e3)};return n.value===0?i=setTimeout(c,1):c(),s}function w(){n.value<100&&(i=setTimeout(()=>{S(),w()},p))}let f;return W(()=>{t.skipHijack!==!0&&(f=!0,lt({start:b,stop:_,hijackFilter:j(()=>t.hijackFilter||null)}))}),Q(()=>{clearTimeout(i),f===!0&&ct(b)}),Object.assign(a,{start:b,stop:_,increment:S}),()=>V("div",{class:g.value,style:k.value,...u.value})}});const pt=(t,e)=>{for(const n of t)if(n.id==e)return n;const a={id:e,sentOutNumber:t.length,moves:[]};return t.push(a),a},A=(t,e,a)=>{e.startsWith("[from]")&&(e=e.slice(6)),a.startsWith("[of]")&&(a=a.slice(4));const n=a.split(":")[0].trim();if(!(n in t))return;const o=t[n],[r,s]=e.split(":");switch(r.trim()){case"item":o.item=s.trim();break;case"ability":o.ability=s.trim();break}},mt=async(t,e,a)=>{var r;const n=(r=a==null?void 0:a.myUsernames)!=null?r:[];if(n.includes(t))return B.Player1;if(n.includes(e))return B.Player2;const o=await st("Which is your username?","Neither",t,e);return o!==0&&a!==void 0&&(n.push(o===1?t:e),await Y(a)),o},ft=async(t,e)=>{const a=await K(),n=`https://replay.pokemonshowdown.com/${t}${e?`-${e}`:""}`,r=await(await fetch(n+".json")).json(),{uploadtime:s,p1:i,p2:p,format:g,log:m,rating:I}=r,k=m.split(`
`);let u=!1;const b=[],S=[],_=[],w=[],f={};let c=s;for(const d of k){const l=d.split("|"),y=l.length;if(y<2||l[1]==="")continue;switch(l[1]){case"t:":{c=parseInt(l[2]);break}case"poke":{const h=l[2]==="p1"?b:S,v=l[3].split(",")[0];h.push(v);break}case"switch":{const h=l[2].split(":")[0],v=l[3].split(",")[0],x=h.slice(0,2)==="p1"?_:w;f[h]=pt(x,v);break}case"move":{const h=l[2].split(":")[0],v=f[h],x=l[3],F=v.moves||[];F.includes(x)||(F.push(x),v.moves=F);break}case"-ability":{const h=l[2].split(":")[0],v=f[h],x=l[3];v.ability=x;break}case"win":{u=l[2]===i;break}default:{l[y-2].startsWith("[from]")&&l[y-1].startsWith("[of]")?A(f,l[y-2],l[y-1]):l[y-1].startsWith("[from]")&&A(f,l[y-1],l[2]);break}}}return{time:c,platform:"Showdown",id:t,url:n,p1:i,p2:p,format:g,rating:I,timeParsed:Math.floor(Date.now()/1e3),winner:u?B.Player1:B.Player2,team1:b,team2:S,team1SentOut:_,team2SentOut:w,remarks:"",tags:[],userPlayer:await mt(i,p,a),log:m}},dt=/^https:\/\/replay.pokemonshowdown.com\/(?<id>\w+?-\w+)(-(?<password>\w+))?(?<remarks>\s+.*)?$/,C=(t,e)=>{const a=e.join(`
`);return t.remarks!==a?(t.remarks+=a,0):1},ht=async(t,e)=>{const a=t.split(`
`),n=100/a.length;let o=null,r=[],s=0;const i={};for(const p of a){const g=dt.exec(p);if(g===null||g.groups===void 0){if(o!==null){const u=p.trim();u!==""&&r.push(u)}continue}o!==null&&(s+=C(o,r),r=[]);const{id:m,password:I,remarks:k}=g.groups;if(console.log(`Importing ${m}...`),o=null,o===null&&(o=await ft(m,I)),k!==void 0){const u=k.trim();u!==""&&r.push(u)}i[m]=o,e.increment(n)}return o!==null&&(s+=C(o,r)),console.log("Finished!"),await X("battles",i),console.log("Saved"),{battles:i,skipped:s}},vt=L({name:"ReplayImporterPage",components:{PageBase:at},setup:()=>{const t=$(""),e=$(),a=$(!1);return{textInput:t,bar:e,parse:async()=>{const o=e.value;if(!!o){o.start(0),a.value=!0;try{const r=t.value.trim();if(r===""){M("Invalid input.","negative");return}const s=await ht(r,o),i=Object.keys(s.battles).length;M(`${i-s.skipped}/${i} Imported.`),t.value=""}catch(r){console.error(r),M("Something went wrong.","negative")}finally{o.stop(),a.value=!1}}},isImporting:a}}}),gt={class:"q-pa-md col",style:{"max-width":"720px"}},yt=N("div",{class:"text-h3"},"Replay Importer",-1);function kt(t,e,a,n,o,r){const s=D("page-base");return H(),J(s,{class:"row items-center justify-evenly",title:"Replay Importer"},{default:z(()=>[R(ut,{ref:"bar",position:"top",color:"accent",size:"10px","skip-hijack":""},null,512),N("div",gt,[yt,R(et,{onSubmit:t.parse,class:"q-mt-md"},{default:z(()=>[R(tt,{outlined:"",modelValue:t.textInput,"onUpdate:modelValue":e[0]||(e[0]=i=>t.textInput=i),label:"Replay URLs",autogrow:"",type:"textarea"},null,8,["modelValue"]),R(G,{class:"q-mt-sm",color:"primary",label:"Import All",type:"submit",loading:t.isImporting},null,8,["loading"])]),_:1},8,["onSubmit"])])]),_:1})}var Rt=ot(vt,[["render",kt]]);export{Rt as default};
