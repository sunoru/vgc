import{c as Q,r as $,a as x,f as U,o as W,h as V,g as E,y as L,A as H,B as q,G as D,z as J,C as R,ab as F,H as G,ac as X,ad as K,ae as Y,af as B,ag as Z}from"./index.1a6d2e54.js";import{b as tt}from"./format.2a3572e1.js";import{Q as et}from"./QInput.ccb816fb.js";import{Q as st}from"./QForm.511aa2e5.js";import{s as M,a as at}from"./dialog.9062dc00.js";import{_ as ot}from"./PageBase.41e93fcf.js";import{_ as rt}from"./plugin-vue_export-helper.21dcd24c.js";import"./use-key-composition.77a17961.js";import"./use-dark.d62858bf.js";import"./focus-manager.387b0375.js";import"./use-form.37a744a4.js";import"./QPage.97be637e.js";const O=XMLHttpRequest,N=O.prototype.open,nt=["top","right","bottom","left"];let T=[],P=0;function it({p:t,pos:e,active:a,horiz:r,reverse:o,dir:i}){let s=1,n=1;return r===!0?(o===!0&&(s=-1),e==="bottom"&&(n=-1),{transform:`translate3d(${s*(t-100)}%,${a?0:n*-200}%,0)`}):(o===!0&&(n=-1),e==="right"&&(s=-1),{transform:`translate3d(${a?0:i*s*-200}%,${n*(t-100)}%,0)`})}function lt(t,e){return typeof e!="number"&&(t<25?e=Math.random()*3+3:t<65?e=Math.random()*3:t<85?e=Math.random()*2:t<99?e=.6:e=0),tt(t+e,0,100)}function ct(t){P++,T.push(t),!(P>1)&&(O.prototype.open=function(e,a){const r=[],o=()=>{T.forEach(s=>{(s.hijackFilter.value===null||s.hijackFilter.value(a)===!0)&&(s.start(),r.push(s.stop))})},i=()=>{r.forEach(s=>{s()})};this.addEventListener("loadstart",o,{once:!0}),this.addEventListener("loadend",i,{once:!0}),N.apply(this,arguments)})}function ut(t){T=T.filter(e=>e.start!==t),P=Math.max(0,P-1),P===0&&(O.prototype.open=N)}var pt=Q({name:"QAjaxBar",props:{position:{type:String,default:"top",validator:t=>nt.includes(t)},size:{type:String,default:"2px"},color:String,skipHijack:Boolean,reverse:Boolean,hijackFilter:Function},emits:["start","stop"],setup(t,{emit:e}){const{proxy:a}=E(),r=$(0),o=$(!1),i=$(!0);let s=0,n,m;const g=x(()=>`q-loading-bar q-loading-bar--${t.position}`+(t.color!==void 0?` bg-${t.color}`:"")+(i.value===!0?"":" no-transition")),u=x(()=>t.position==="top"||t.position==="bottom"),I=x(()=>u.value===!0?"height":"width"),k=x(()=>{const c=o.value,d=it({p:r.value,pos:t.position,active:c,horiz:u.value,reverse:a.$q.lang.rtl===!0&&["top","bottom"].includes(t.position)?t.reverse===!1:t.reverse,dir:a.$q.lang.rtl===!0?-1:1});return d[I.value]=t.size,d.opacity=c?1:0,d}),p=x(()=>o.value===!0?{role:"progressbar","aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":r.value}:{"aria-hidden":"true"});function b(c=300){const d=m;return m=Math.max(0,c)||0,s++,s>1?(d===0&&c>0?w():d>0&&c<=0&&clearTimeout(n),s):(clearTimeout(n),e("start"),r.value=0,n=setTimeout(()=>{i.value=!0,c>0&&w()},o.value===!0?500:1),o.value!==!0&&(o.value=!0,i.value=!1),s)}function S(c){return s>0&&(r.value=lt(r.value,c)),s}function _(){if(s=Math.max(0,s-1),s>0)return s;clearTimeout(n),e("stop");const c=()=>{i.value=!0,r.value=100,n=setTimeout(()=>{o.value=!1},1e3)};return r.value===0?n=setTimeout(c,1):c(),s}function w(){r.value<100&&(n=setTimeout(()=>{S(),w()},m))}let f;return U(()=>{t.skipHijack!==!0&&(f=!0,ct({start:b,stop:_,hijackFilter:x(()=>t.hijackFilter||null)}))}),W(()=>{clearTimeout(n),f===!0&&ut(b)}),Object.assign(a,{start:b,stop:_,increment:S}),()=>V("div",{class:g.value,style:k.value,...p.value})}});const mt=(t,e)=>{for(const r of t)if(r.id==e)return r;const a={id:e,sentOutNumber:t.length,moves:[]};return t.push(a),a},z=(t,e,a)=>{e.startsWith("[from]")&&(e=e.slice(6)),a.startsWith("[of]")&&(a=a.slice(4));const r=a.split(":")[0].trim();if(!(r in t))return;const o=t[r],[i,s]=e.split(":");switch(i.trim()){case"item":o.item=s.trim();break;case"ability":o.ability=s.trim();break}},ft=async(t,e,a)=>{var i;const r=(i=a==null?void 0:a.myUsernames)!=null?i:[];if(r.includes(t))return B.Player1;if(r.includes(e))return B.Player2;const o=await at("Which is your username?","Neither",t,e);return o!==0&&a!==void 0&&(r.push(o===1?t:e),await Z(a)),o},dt=async(t,e)=>{const a=await Y(),r=`https://replay.pokemonshowdown.com/${t}${e?`-${e}`:""}`,i=await(await fetch(r+".json")).json(),{uploadtime:s,p1:n,p2:m,format:g,log:u,rating:I}=i,k=u.split(`
`);let p=!1;const b=[],S=[],_=[],w=[],f={};let c=s;for(const d of k){const l=d.split("|"),y=l.length;if(y<2||l[1]==="")continue;switch(l[1]){case"t:":{c=parseInt(l[2]);break}case"poke":{const h=l[2]==="p1"?b:S,v=l[3].split(",")[0];h.push(v);break}case"switch":{const h=l[2].split(":")[0],v=l[3].split(",")[0],j=h.slice(0,2)==="p1"?_:w;f[h]=mt(j,v);break}case"move":{const h=l[2].split(":")[0],v=f[h],j=l[3],C=v.moves||[];C.includes(j)||(C.push(j),v.moves=C);break}case"-ability":{const h=l[2].split(":")[0],v=f[h],j=l[3];v.ability=j;break}case"win":{p=l[2]===n;break}default:{l[y-2].startsWith("[from]")&&l[y-1].startsWith("[of]")?z(f,l[y-2],l[y-1]):l[y-1].startsWith("[from]")&&z(f,l[y-1],l[2]);break}}}return{time:c,platform:"Showdown",id:t,url:r,p1:n,p2:m,format:g,rating:I,timeParsed:Math.floor(Date.now()/1e3),winner:p?B.Player1:B.Player2,team1:b,team2:S,team1SentOut:_,team2SentOut:w,remarks:" ",tags:[],userPlayer:await ft(n,m,a),log:u}},ht=/^https:\/\/replay.pokemonshowdown.com\/(?<id>\w+?-\w+)(-(?<password>\w+))?(?<remarks>\s+.*)?$/,A=(t,e)=>{const a=e.join(`
`);return t.remarks!==a?(t.remarks===" "&&(t.remarks=""),t.remarks+=a,0):1},vt=async(t,e)=>{const a=t.split(`
`),r=100/a.length;let o=null,i=[],s=0;const n={};for(const m of a){const g=ht.exec(m);if(g===null||g.groups===void 0){if(o!==null){const p=m.trim();p!==""&&i.push(p)}continue}o!==null&&(s+=A(o,i),i=[]);const{id:u,password:I,remarks:k}=g.groups;if(console.log(`Importing ${u}...`),o=u in n?n[u]:await X("battles",u),o===null&&(o=await dt(u,I)),k!==void 0){const p=k.trim();p!==""&&i.push(p)}n[u]=o,e.increment(r)}return o!==null&&(s+=A(o,i)),console.log("Finished!"),await K("battles",n),console.log("Saved"),{battles:n,skipped:s}},gt=L({name:"ReplayImporterPage",components:{PageBase:ot},setup:()=>{const t=$(""),e=$(),a=$(!1);return{textInput:t,bar:e,parse:async()=>{const o=e.value;if(!!o){o.start(0),a.value=!0;try{const i=t.value.trim();if(i===""){M("Invalid input.","negative");return}const s=await vt(i,o),n=Object.keys(s.battles).length;M(`${n-s.skipped}/${n} Imported.`),t.value=""}catch(i){console.error(i),M("Something went wrong.","negative")}finally{o.stop(),a.value=!1}}},isImporting:a}}}),yt={class:"q-pa-md col",style:{"max-width":"720px"}},kt=F("div",{class:"text-h3"},"Replay Importer",-1);function bt(t,e,a,r,o,i){const s=D("page-base");return J(),H(s,{class:"row items-center justify-evenly",title:"Replay Importer"},{default:q(()=>[R(pt,{ref:"bar",position:"top",color:"accent",size:"10px","skip-hijack":""},null,512),F("div",yt,[kt,R(st,{onSubmit:t.parse,class:"q-mt-md"},{default:q(()=>[R(et,{outlined:"",modelValue:t.textInput,"onUpdate:modelValue":e[0]||(e[0]=n=>t.textInput=n),label:"Replay URLs",autogrow:"",type:"textarea"},null,8,["modelValue"]),R(G,{class:"q-mt-sm",color:"primary",label:"Import All",type:"submit",loading:t.isImporting},null,8,["loading"])]),_:1},8,["onSubmit"])])]),_:1})}var Ot=rt(gt,[["render",bt]]);export{Ot as default};
