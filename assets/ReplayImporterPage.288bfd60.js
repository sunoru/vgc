var L=Object.defineProperty;var q=Object.getOwnPropertySymbols;var O=Object.prototype.hasOwnProperty,D=Object.prototype.propertyIsEnumerable;var C=(t,e,s)=>e in t?L(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,F=(t,e)=>{for(var s in e||(e={}))O.call(e,s)&&C(t,s,e[s]);if(q)for(var s of q(e))D.call(e,s)&&C(t,s,e[s]);return t};import{c as H,r as I,a as w,o as N,d as J,h as X,g as G,a8 as W,_ as K,Q as Y,R as Z,S as tt,T as U,U as B,a7 as V,a0 as et}from"./index.fca2a0f3.js";import{b as st}from"./format.e8610ab1.js";import{Q as at,a as ot,g as nt,s as rt,b as it,c as lt}from"./storage.bf68715b.js";import{Q as ct}from"./QPage.2ccaab82.js";const Q=XMLHttpRequest,E=Q.prototype.open,ut=["top","right","bottom","left"];let T=[],P=0;function pt({p:t,pos:e,active:s,horiz:n,reverse:a,dir:r}){let o=1,l=1;return n===!0?(a===!0&&(o=-1),e==="bottom"&&(l=-1),{transform:`translate3d(${o*(t-100)}%,${s?0:l*-200}%,0)`}):(a===!0&&(l=-1),e==="right"&&(o=-1),{transform:`translate3d(${s?0:r*o*-200}%,${l*(t-100)}%,0)`})}function mt(t,e){return typeof e!="number"&&(t<25?e=Math.random()*3+3:t<65?e=Math.random()*3:t<85?e=Math.random()*2:t<99?e=.6:e=0),st(t+e,0,100)}function ft(t){P++,T.push(t),!(P>1)&&(Q.prototype.open=function(e,s){const n=[],a=()=>{T.forEach(o=>{(o.hijackFilter.value===null||o.hijackFilter.value(s)===!0)&&(o.start(),n.push(o.stop))})},r=()=>{n.forEach(o=>{o()})};this.addEventListener("loadstart",a,{once:!0}),this.addEventListener("loadend",r,{once:!0}),E.apply(this,arguments)})}function dt(t){T=T.filter(e=>e.start!==t),P=Math.max(0,P-1),P===0&&(Q.prototype.open=E)}var ht=H({name:"QAjaxBar",props:{position:{type:String,default:"top",validator:t=>ut.includes(t)},size:{type:String,default:"2px"},color:String,skipHijack:Boolean,reverse:Boolean,hijackFilter:Function},emits:["start","stop"],setup(t,{emit:e}){const{proxy:s}=G(),n=I(0),a=I(!1),r=I(!0);let o=0,l,m;const v=w(()=>`q-loading-bar q-loading-bar--${t.position}`+(t.color!==void 0?` bg-${t.color}`:"")+(r.value===!0?"":" no-transition")),u=w(()=>t.position==="top"||t.position==="bottom"),x=w(()=>u.value===!0?"height":"width"),g=w(()=>{const c=a.value,i=pt({p:n.value,pos:t.position,active:c,horiz:u.value,reverse:s.$q.lang.rtl===!0&&["top","bottom"].includes(t.position)?t.reverse===!1:t.reverse,dir:s.$q.lang.rtl===!0?-1:1});return i[x.value]=t.size,i.opacity=c?1:0,i}),p=w(()=>a.value===!0?{role:"progressbar","aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":n.value}:{"aria-hidden":"true"});function y(c=300){const i=m;return m=Math.max(0,c)||0,o++,o>1?(i===0&&c>0?f():i>0&&c<=0&&clearTimeout(l),o):(clearTimeout(l),e("start"),n.value=0,l=setTimeout(()=>{r.value=!0,c>0&&f()},a.value===!0?500:1),a.value!==!0&&(a.value=!0,r.value=!1),o)}function j(c){return o>0&&(n.value=mt(n.value,c)),o}function $(){if(o=Math.max(0,o-1),o>0)return o;clearTimeout(l),e("stop");const c=()=>{r.value=!0,n.value=100,l=setTimeout(()=>{a.value=!1},1e3)};return n.value===0?l=setTimeout(c,1):c(),o}function f(){n.value<100&&(l=setTimeout(()=>{j(),f()},m))}let S;return N(()=>{t.skipHijack!==!0&&(S=!0,ft({start:y,stop:$,hijackFilter:w(()=>t.hijackFilter||null)}))}),J(()=>{clearTimeout(l),S===!0&&dt(y)}),Object.assign(s,{start:y,stop:$,increment:j}),()=>X("div",F({class:v.value,style:g.value},p.value))}});const M=(t,e="primary",s={})=>(s.message=t,s.color=e,W.create(s)),vt=(t,...e)=>new Promise(s=>{const n={message:t,timeout:0,actions:e.map((r,o)=>({label:r,handler:()=>{a(),s(o)},color:"info",noCaps:!0}))},a=W.create(n)});var R=(t=>(t[t.None=0]="None",t[t.Player1=1]="Player1",t[t.Player2=2]="Player2",t))(R||{});const gt=(t,e)=>{for(const n of t)if(n.id==e)return n;const s={id:e,moves:[]};return t.push(s),s},z=(t,e,s)=>{e.startsWith("[from]")&&(e=e.slice(6)),s.startsWith("[of]")&&(s=s.slice(4));const n=s.split(":")[0].trim();if(!(n in t))return;const a=t[n],[r,o]=e.split(":");switch(r.trim()){case"item":a.item=o.trim();break;case"ability":a.ability=o.trim();break}},kt=async(t,e,s)=>{var r;const n=(r=s==null?void 0:s.myUsernames)!=null?r:[];if(n.includes(t))return R.Player1;if(n.includes(e))return R.Player2;const a=await vt("Which is your username?","Neither",t,e);return a!==0&&s!==void 0&&(n.push(a===1?t:e),await lt(s)),a},yt=async(t,e)=>{const s=await it(),n=`https://replay.pokemonshowdown.com/${t}${e?`-${e}`:""}.json`,a=await fetch(n);console.log(a);const r=await a.json(),{uploadtime:o,p1:l,p2:m,format:v,log:u}=r,x=u.split(`
`);let g=!1;const p=[],y=[],j=[],$=[],f={};let S=o;for(const c of x){const i=c.split("|"),k=i.length;if(k<2||i[1]==="")continue;switch(i[1]){case"t:":{S=parseInt(i[2]);break}case"poke":{const d=i[2]==="p1"?p:y,h=i[3].split(",")[0];d.push(h);break}case"switch":{const d=i[2].split(":")[0],h=i[3].split(",")[0],b=d.slice(0,2)==="p1"?j:$;f[d]=gt(b,h);break}case"move":{const d=i[2].split(":")[0],h=f[d],b=i[3],_=h.moves||[];_.includes(b)||(_.push(b),h.moves=_);break}case"-ability":{const d=i[2].split(":")[0],h=f[d],b=i[3];h.ability=b;break}case"win":{g=i[2]===l;break}default:{i[k-2].startsWith("[from]")&&i[k-1].startsWith("[of]")?z(f,i[k-2],i[k-1]):i[k-1].startsWith("[from]")&&z(f,i[k-1],i[2]);break}}}return{time:S,platform:"Showdown",id:t,url:n,p1:l,p2:m,format:v,timeParsed:Math.floor(Date.now()/1e3),winner:g?R.Player1:R.Player2,team1:p,team2:y,team1SentOut:j,team2SentOut:$,remarks:"",tags:[],userPlayer:await kt(l,m,s),log:u}},bt=/^https:\/\/replay.pokemonshowdown.com\/(?<id>\w+?-\w+)(-(?<password>\w+))?(?<remarks>\s+.*)?$/,A=(t,e)=>{const s=e.join(`
`);return t.remarks!==s?(t.remarks+=s,0):1},wt=async(t,e)=>{const s=t.split(`
`),n=100/s.length;let a=null,r=[],o=0;const l={};for(const m of s){const v=bt.exec(m);if(v===null||v.groups===void 0){if(a!==null){const p=m.trim();p!==""&&r.push(p)}continue}a!==null&&(o+=A(a,r),r=[]);const{id:u,password:x,remarks:g}=v.groups;if(console.log(`Importing ${u}...`),a=u in l?l[u]:await nt(u),a===null&&(a=await yt(u,x)),g!==void 0){const p=g.trim();p!==""&&r.push(p)}l[u]=a,e.increment(n)}return a!==null&&(o+=A(a,r)),console.log("Finished!"),await rt(l),console.log("Saved"),{battles:l,skipped:o}},xt=Y({name:"ReplayImporterPage",setup:()=>{const t=I(""),e=I();return{textInput:t,bar:e,parse:async()=>{const n=e.value;if(!!n){n.start(0);try{const a=t.value.trim();if(a===""){M("Invalid input.","negative");return}const r=await wt(a,n),o=Object.keys(r.battles).length;M(`${o-r.skipped}/${o} Imported.`),t.value=""}catch(a){console.error(a),M("Something went wrong.","negative")}finally{n.stop()}}}}}}),jt={class:"q-pa-md col",style:{"max-width":"720px"}},$t=V("div",{class:"text-h3"},"Replay Importer",-1);function St(t,e,s,n,a,r){return Z(),tt(ct,{class:"row items-center justify-evenly"},{default:U(()=>[B(ht,{ref:"bar",position:"top",color:"accent",size:"10px","skip-hijack":""},null,512),V("div",jt,[$t,B(ot,{onSubmit:t.parse,class:"q-mt-md"},{default:U(()=>[B(at,{outlined:"",modelValue:t.textInput,"onUpdate:modelValue":e[0]||(e[0]=o=>t.textInput=o),label:"Replay URLs",autogrow:"",type:"textarea"},null,8,["modelValue"]),B(et,{class:"q-mt-sm",color:"primary",label:"Import All",type:"submit"})]),_:1},8,["onSubmit"])])]),_:1})}var Mt=K(xt,[["render",St]]);export{Mt as default};
